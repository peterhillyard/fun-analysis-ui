<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <h1>Data Visualizer</h1>
    
    <div>
        <input type="file" id="zipFileInput" accept=".zip" />
        <label for="zipFileInput">Choose a ZIP file</label>
    </div>

    <div style="margin-top: 10px;">
        <label>
            <input type="checkbox" id="showBleTxIds" checked />
            Show BLE TX IDs
        </label>
        <label style="margin-left: 20px;">
            BLE Label:
            <select id="bleLabelOption">
                <option value="full">Full ID</option>
                <option value="last4" selected>Last 4 chars</option>
                <option value="none">No Label</option>
            </select>
        </label>
        <label style="margin-left: 20px;">
            <input type="checkbox" id="showBasestations" checked />
            Show Basestations
        </label>
        <label style="margin-left: 20px;">
            Basestation Coordinate:
            <select id="basestationCoordinateOption">
                <option value="augi_location" selected>Augi Location</option>
                <option value="room_centroid">Room Centroid</option>
            </select>
        </label>
        <label style="margin-left: 20px;">
            Basestation Label:
            <select id="basestationLabelOption">
                <option value="full">Full ID</option>
                <option value="last4" selected>Last 4 chars</option>
                <option value="none">No Label</option>
            </select>
        </label>
    </div>

    <div id="staticWindowInfo" style="margin-top: 20px; display: none;">
        <h3>Static Window</h3>
        <p><strong>Start:</strong> <span id="startTime"></span></p>
        <p><strong>End:</strong> <span id="endTime"></span></p>
        
        <div style="margin-top: 15px;">
            <label>
                <strong>Select BLE TX ID:</strong>
                <select id="bleTxIdSelector" style="margin-left: 10px;">
                    <option value="">-- Select a BLE TX ID --</option>
                </select>
            </label>
        </div>
        
        <div id="bleDataTable" style="margin-top: 15px; display: none;">
            <h4>Coprocessor Hearing Count</h4>
            <table id="coprocessorTable" style="border-collapse: collapse; width: 100%; max-width: 600px;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Coprocessor ID</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Count</th>
                    </tr>
                </thead>
                <tbody id="coprocessorTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div id="imageContainer" style="margin-top: 20px; position: relative; display: inline-block;">
        <img id="floorPlanImage" style="max-width: 100%; display: none;" />
        <div id="dotsContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
        <div id="hoverInfo" style="position: absolute; display: none; background-color: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; white-space: nowrap;"></div>
    </div>

    <script>
        let aggregatedData = null;
        let currentImageElement = null;
        let bleData = null;
        
        function parseCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index]?.trim();
                });
                data.push(row);
            }
            
            return data;
        }
        
        function generateCoprocessorTable(bleTxId) {
            if (!bleData || !bleTxId) return;
            
            const tableBody = document.getElementById('coprocessorTableBody');
            tableBody.innerHTML = '';
            
            // Filter data for the selected BLE TX ID and count by coprocessor
            const coprocessorCounts = {};
            bleData.forEach(row => {
                if (row.ble_tx_id === bleTxId) {
                    const coprocessorId = row.coprocessor_id;
                    if (coprocessorId) {
                        coprocessorCounts[coprocessorId] = (coprocessorCounts[coprocessorId] || 0) + 1;
                    }
                }
            });
            
            // Sort by count descending
            const sortedEntries = Object.entries(coprocessorCounts).sort((a, b) => b[1] - a[1]);
            
            // Populate table
            if (sortedEntries.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 2;
                cell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: center; color: #666;';
                cell.textContent = 'No data found for this BLE TX ID';
            } else {
                sortedEntries.forEach(([coprocessorId, count]) => {
                    const row = tableBody.insertRow();
                    const cellId = row.insertCell(0);
                    const cellCount = row.insertCell(1);
                    
                    cellId.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
                    cellCount.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
                    
                    cellId.textContent = coprocessorId;
                    cellCount.textContent = count;
                });
            }
            
            document.getElementById('bleDataTable').style.display = 'block';
        }
        
        function renderDots() {
            if (!currentImageElement || !aggregatedData) return;
            
            const imgElement = currentImageElement;
            const dotsContainer = document.getElementById('dotsContainer');
            dotsContainer.innerHTML = ''; // Clear any existing dots
            
            // Get the scale factor between natural and displayed size
            const scaleX = imgElement.clientWidth / imgElement.naturalWidth;
            const scaleY = imgElement.clientHeight / imgElement.naturalHeight;
            
            const showBleTxIds = document.getElementById('showBleTxIds').checked;
            const showBasestations = document.getElementById('showBasestations').checked;
            const bleLabelOption = document.getElementById('bleLabelOption').value;
            const basestationLabelOption = document.getElementById('basestationLabelOption').value;
            const basestationCoordinateOption = document.getElementById('basestationCoordinateOption').value;
            
            // Display BLE transmitter dots
            if (showBleTxIds && aggregatedData.ble_tx_id_coordinates && aggregatedData.ble_tx_id_coordinates.length > 0) {
                aggregatedData.ble_tx_id_coordinates.forEach(item => {
                    if (item.coordinate_pixels && item.coordinate_pixels.length === 2) {
                        const dot = document.createElement('div');
                        dot.style.position = 'absolute';
                        dot.style.left = `${item.coordinate_pixels[0] * scaleX}px`;
                        dot.style.top = `${item.coordinate_pixels[1] * scaleY}px`;
                        dot.style.width = '10px';
                        dot.style.height = '10px';
                        dot.style.backgroundColor = 'red';
                        dot.style.borderRadius = '50%';
                        dot.style.transform = 'translate(-50%, -50%)';
                        dot.title = `BLE TX ID: ${item.ble_tx_id}`;
                        
                        dotsContainer.appendChild(dot);
                        
                        // Add label next to the dot if not 'none'
                        if (bleLabelOption !== 'none') {
                            const label = document.createElement('div');
                            label.style.position = 'absolute';
                            label.style.left = `${item.coordinate_pixels[0] * scaleX + 10}px`;
                            label.style.top = `${item.coordinate_pixels[1] * scaleY}px`;
                            label.style.transform = 'translateY(-50%)';
                            label.style.color = 'red';
                            label.style.fontWeight = 'bold';
                            label.style.fontSize = '12px';
                            label.style.whiteSpace = 'nowrap';
                            label.style.textShadow = '1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white';
                            
                            if (bleLabelOption === 'full') {
                                label.textContent = item.ble_tx_id;
                            } else if (bleLabelOption === 'last4') {
                                label.textContent = item.ble_tx_id.slice(-4);
                            }
                            
                            dotsContainer.appendChild(label);
                        }
                    }
                });
            }
            
            // Display basestation dots
            if (showBasestations && aggregatedData.augi_metadata && aggregatedData.augi_metadata.length > 0) {
                aggregatedData.augi_metadata.forEach(item => {
                    // Determine which coordinates to use
                    let coordinates;
                    if (basestationCoordinateOption === 'room_centroid') {
                        coordinates = item.room_centroid_coordinate_pixels;
                    } else {
                        coordinates = item.augi_location_coordinate_pixels;
                    }
                    
                    if (coordinates && coordinates.length === 2) {
                        const dot = document.createElement('div');
                        dot.style.position = 'absolute';
                        dot.style.left = `${coordinates[0] * scaleX}px`;
                        dot.style.top = `${coordinates[1] * scaleY}px`;
                        dot.style.width = '10px';
                        dot.style.height = '10px';
                        dot.style.backgroundColor = 'blue';
                        dot.style.borderRadius = '50%';
                        dot.style.transform = 'translate(-50%, -50%)';
                        dot.title = `Basestation ID: ${item.basestation_id}, Coprocessor: ${item.coprocessor}, Room id: ${item.room_id}`;
                        
                        dotsContainer.appendChild(dot);
                        
                        // Add label next to the dot if not 'none'
                        if (basestationLabelOption !== 'none') {
                            const label = document.createElement('div');
                            label.style.position = 'absolute';
                            label.style.left = `${coordinates[0] * scaleX + 10}px`;
                            label.style.top = `${coordinates[1] * scaleY}px`;
                            label.style.transform = 'translateY(-50%)';
                            label.style.color = 'blue';
                            label.style.fontWeight = 'bold';
                            label.style.fontSize = '12px';
                            label.style.whiteSpace = 'nowrap';
                            label.style.textShadow = '1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white';
                            
                            if (basestationLabelOption === 'full') {
                                label.textContent = `${item.basestation_id} (${item.coprocessor})`;
                            } else if (basestationLabelOption === 'last4') {
                                label.textContent = `${item.basestation_id.slice(-4)} (${item.coprocessor.slice(-4)})`;
                            }
                            
                            dotsContainer.appendChild(label);
                        }
                    }
                });
            }
        }
        
        // Add event listeners to checkboxes and dropdown
        document.getElementById('showBleTxIds').addEventListener('change', renderDots);
        document.getElementById('bleLabelOption').addEventListener('change', renderDots);
        document.getElementById('showBasestations').addEventListener('change', renderDots);
        document.getElementById('basestationCoordinateOption').addEventListener('change', renderDots);
        document.getElementById('basestationLabelOption').addEventListener('change', renderDots);
        
        // Add event listener for BLE TX ID selector
        document.getElementById('bleTxIdSelector').addEventListener('change', function(event) {
            generateCoprocessorTable(event.target.value);
        });
        
        document.getElementById('zipFileInput').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            if (!file.name.endsWith('.zip')) {
                console.error('Please select a ZIP file');
                return;
            }
            
            try {
                console.log(`Processing ZIP file: ${file.name}`);
                
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                
                console.log('File sizes in ZIP archive:');
                console.log('----------------------------');
                
                let floorPlanFile = null;
                let aggregatedJsonFile = null;
                let bleDataFile = null;
                
                Object.keys(contents.files).forEach(filename => {
                    const fileData = contents.files[filename];
                    if (!fileData.dir) {
                        console.log(`${filename}: ${fileData._data.uncompressedSize} bytes`);
                        
                        // Check if this is the floor_plan.jpg file
                        if (filename.endsWith('floor_plan.jpg') || filename === 'floor_plan.jpg') {
                            floorPlanFile = fileData;
                        }
                        
                        // Check if this is the aggregated.json file
                        if (filename.endsWith('manual_gt_data.json') || filename === 'manual_gt_data.json') {
                            aggregatedJsonFile = fileData;
                        }
                        
                        // Check if this is the ble_data.csv file
                        if (filename.endsWith('ble_data.csv') || filename === 'ble_data.csv') {
                            bleDataFile = fileData;
                        }
                    }
                });
                
                console.log('----------------------------');
                
                // Load the aggregated.json file if found
                if (aggregatedJsonFile) {
                    const jsonText = await aggregatedJsonFile.async('text');
                    aggregatedData = JSON.parse(jsonText);
                    console.log('manual_gt_data.json loaded:', aggregatedData);
                    
                    // Display static_window if available
                    if (aggregatedData.static_window && aggregatedData.static_window.length === 2) {
                        document.getElementById('startTime').textContent = aggregatedData.static_window[0];
                        document.getElementById('endTime').textContent = aggregatedData.static_window[1];
                        document.getElementById('staticWindowInfo').style.display = 'block';
                        
                        console.log('Static window displayed:', aggregatedData.static_window);
                    }
                    
                    // Populate BLE TX ID dropdown
                    if (aggregatedData.ble_tx_id_coordinates && aggregatedData.ble_tx_id_coordinates.length > 0) {
                        const selector = document.getElementById('bleTxIdSelector');
                        // Clear existing options except the first one
                        selector.innerHTML = '<option value="">-- Select a BLE TX ID --</option>';
                        
                        aggregatedData.ble_tx_id_coordinates.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.ble_tx_id;
                            option.textContent = item.ble_tx_id;
                            selector.appendChild(option);
                        });
                        
                        console.log(`Populated dropdown with ${aggregatedData.ble_tx_id_coordinates.length} BLE TX IDs`);
                    }
                }
                
                // Load the ble_data.csv file if found
                if (bleDataFile) {
                    const csvText = await bleDataFile.async('text');
                    bleData = parseCsv(csvText);
                    console.log('ble_data.csv loaded:', bleData.length, 'rows');
                }
                
                // Display the floor plan image if found
                if (floorPlanFile) {
                    const blob = await floorPlanFile.async('blob');
                    const imageUrl = URL.createObjectURL(blob);
                    const imgElement = document.getElementById('floorPlanImage');
                    
                    imgElement.onload = function() {
                        imgElement.style.display = 'block';
                        console.log('Floor plan image displayed');
                        currentImageElement = imgElement;
                        renderDots();
                    };
                    
                    imgElement.src = imageUrl;
                } else {
                    console.warn('floor_plan.jpg not found in the ZIP file');
                }
            } catch (error) {
                console.error('Error processing ZIP file:', error);
            }
        });
    </script>
</body>
</html>